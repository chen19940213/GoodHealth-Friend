{"version":3,"file":"components/ec-canvas/index.js","mappings":";;;;;;;;;;;AAAA;;AACA;;AAEA;;AACA;;AAEA;AACA;AACA;;AACA;AACA;;AACA;AACA;AACA;AACA;;AACA;;AAEA;;AACA;;AAEA;;AACA;;AAEA;;AACA;;AACA;;;AAGA;;AACA;;AAEA;;AACA;;AAEA;;AACA;AACA;AACA;AAAA;AAAA;AAAA;;AACA;;AACA;;AAEA;;AACA;AACA;AACA;AAAA;AAAA;;AACA;;AACA;AAAA;AAAA;;AACA;;AAEA;AACA;AACA;AACA;AACA;;AACA;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;AAAA;AAAA;AAAA;;AACA;AAAA;AAAA;;AACA;;AACA;;AAEA;;AACA;AACA;AACA;AAAA;AACA;AAAA;;AACA;;AACA;;AACA;;AAEA;;AACA;AAAA;AAAA;;AAEA;;AACA;;;AAGA;;AACA;;;;;;;;;;;;;AClFA;;;;;;;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAFA;AAKA;AACA;AADA;AAIA;AACA;AADA;AAIA;AACA;AACA;AAFA;AAdA;AAoBA;AACA;AADA;AAIA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAJA;AAMA;AACA;AACA;AAEA;AAAA;;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAJA;AAMA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AAFA;AAIA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;AAFA;AAIA;AACA;AACA;AAhKA;AAzDA;AA6NA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACjQA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;AAEA;;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AAEA;AACA;AAAA;AAGA;AACA;AAAA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;AACA;AAIA;AACA;AACA;AACA;AAGA;AACA;AACA;AAPA;AASA;AAEA;AACA;AACA;AACA;AAEA;AAAA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AAFA;AAIA;AACA;AAFA;AAIA;AACA;AAFA;AAKA;AACA;AACA;AACA;AACA;AACA;AAFA;AAIA;AACA;AACA;;;AAEA;AACA;AACA;AAKA;AACA;AAEA;AACA;;;AARA;AACA;AACA;AAOA;AACA;AAEA;AACA;;;;AAvHA;;;;;;;;;;;;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://AppStarCardWXSS/.._.._.._.._.._webpack_bootstrap","webpack://AppStarCardWXSS/.._.._.._.._.._src_index.js","webpack://AppStarCardWXSS/.._.._.._.._.._src_wx-canvas.js","webpack://AppStarCardWXSS/._node_modules_@babel_runtime_helpers_typeof.js"],"sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","import WxCanvas from './wx-canvas';\n\nlet ctx;\n\nfunction compareVersion(v1, v2) {\n  v1 = v1.split('.')\n  v2 = v2.split('.')\n  const len = Math.max(v1.length, v2.length)\n\n  while (v1.length < len) {\n    v1.push('0')\n  }\n  while (v2.length < len) {\n    v2.push('0')\n  }\n\n  for (let i = 0; i < len; i++) {\n    const num1 = parseInt(v1[i])\n    const num2 = parseInt(v2[i])\n\n    if (num1 > num2) {\n      return 1\n    } else if (num1 < num2) {\n      return -1\n    }\n  }\n  return 0\n}\n\nComponent({\n  properties: {\n    canvasId: {\n      type: String,\n      value: 'ec-canvas'\n    },\n\n    echarts: {\n      type: Object\n    },\n\n    ec: {\n      type: Object\n    },\n\n    forceUseOldCanvas: {\n      type: Boolean,\n      value: false\n    }\n  },\n\n  data: {\n    isUseNewCanvas: false\n  },\n\n  ready: function () {\n    if (!this.data.echarts) {\n      console.warn('组件需要传入 echarts')\n      return;\n    }\n\n    // Disable prograssive because drawImage doesn't support DOM as parameter\n    // See https://developers.weixin.qq.com/miniprogram/dev/api/canvas/CanvasContext.drawImage.html\n    this.data.echarts.registerPreprocessor(option => {\n      if (option && option.series) {\n        if (option.series.length > 0) {\n          option.series.forEach(series => {\n            series.progressive = 0;\n          });\n        }\n        else if (typeof option.series === 'object') {\n          option.series.progressive = 0;\n        }\n      }\n    });\n\n    if (!this.data.ec) {\n      console.warn('组件需绑定 ec 变量，例：<ec-canvas id=\"mychart-dom-bar\" '\n        + 'canvas-id=\"mychart-bar\" ec=\"{{ ec }}\"></ec-canvas>');\n      return;\n    }\n\n    if (!this.data.ec.lazyLoad) {\n      this.init();\n    }\n  },\n\n  methods: {\n    init: function (callback) {\n      const version = wx.getSystemInfoSync().SDKVersion\n\n      const canUseNewCanvas = compareVersion(version, '2.9.0') >= 0;\n      const forceUseOldCanvas = this.data.forceUseOldCanvas;\n      const isUseNewCanvas = canUseNewCanvas && !forceUseOldCanvas;\n      this.setData({ isUseNewCanvas });\n\n      if (forceUseOldCanvas && canUseNewCanvas) {\n        console.warn('开发者强制使用旧canvas,建议关闭');\n      }\n\n      if (isUseNewCanvas) {\n        // console.log('微信基础库版本大于2.9.0，开始使用<canvas type=\"2d\"/>');\n        // 2.9.0 可以使用 <canvas type=\"2d\"></canvas>\n        this.initByNewWay(callback);\n      } else {\n        const isValid = compareVersion(version, '1.9.91') >= 0\n        if (!isValid) {\n          console.error('微信基础库版本过低，需大于等于 1.9.91。'\n            + '参见：https://github.com/ecomfe/echarts-for-weixin'\n            + '#%E5%BE%AE%E4%BF%A1%E7%89%88%E6%9C%AC%E8%A6%81%E6%B1%82');\n          return;\n        } else {\n          console.warn('建议将微信基础库调整大于等于2.9.0版本。升级后绘图将有更好性能');\n          this.initByOldWay(callback);\n        }\n      }\n    },\n\n    initByOldWay(callback) {\n      // 1.9.91 <= version < 2.9.0：原来的方式初始化\n      ctx = wx.createCanvasContext(this.data.canvasId, this);\n      const canvas = new WxCanvas(ctx, this.data.canvasId, false);\n\n      this.data.echarts.setCanvasCreator(() => {\n        return canvas;\n      });\n      // const canvasDpr = wx.getSystemInfoSync().pixelRatio // 微信旧的canvas不能传入dpr\n      const canvasDpr = 1\n      var query = wx.createSelectorQuery().in(this);\n      query.select('.ec-canvas').boundingClientRect(res => {\n        if (typeof callback === 'function') {\n          this.chart = callback(canvas, res.width, res.height, canvasDpr);\n        }\n        else if (this.data.ec && typeof this.data.ec.onInit === 'function') {\n          this.chart = this.data.ec.onInit(canvas, res.width, res.height, canvasDpr);\n        }\n        else {\n          this.triggerEvent('init', {\n            canvas: canvas,\n            width: res.width,\n            height: res.height,\n            canvasDpr: canvasDpr // 增加了dpr，可方便外面echarts.init\n          });\n        }\n      }).exec();\n    },\n\n    initByNewWay(callback) {\n      // version >= 2.9.0：使用新的方式初始化\n      const query = wx.createSelectorQuery().in(this)\n      query\n        .select('.ec-canvas')\n        .fields({ node: true, size: true })\n        .exec(res => {\n          const canvasNode = res[0].node\n          this.canvasNode = canvasNode\n\n          const canvasDpr = wx.getSystemInfoSync().pixelRatio\n          const canvasWidth = res[0].width\n          const canvasHeight = res[0].height\n\n          const ctx = canvasNode.getContext('2d')\n\n          const canvas = new WxCanvas(ctx, this.data.canvasId, true, canvasNode)\n          this.data.echarts.setCanvasCreator(() => {\n            return canvas\n          })\n\n          if (typeof callback === 'function') {\n            this.chart = callback(canvas, canvasWidth, canvasHeight, canvasDpr)\n          } else if (this.data.ec && typeof this.data.ec.onInit === 'function') {\n            this.chart = this.data.ec.onInit(canvas, canvasWidth, canvasHeight, canvasDpr)\n          } else {\n            this.triggerEvent('init', {\n              canvas: canvas,\n              width: canvasWidth,\n              height: canvasHeight,\n              dpr: canvasDpr\n            })\n          }\n        })\n    },\n    canvasToTempFilePath(opt) {\n      if (this.data.isUseNewCanvas) {\n        // 新版\n        const query = wx.createSelectorQuery().in(this)\n        query\n          .select('.ec-canvas')\n          .fields({ node: true, size: true })\n          .exec(res => {\n            const canvasNode = res[0].node\n            opt.canvas = canvasNode\n            wx.canvasToTempFilePath(opt)\n          })\n      } else {\n        // 旧的\n        if (!opt.canvasId) {\n          opt.canvasId = this.data.canvasId;\n        }\n        ctx.draw(true, () => {\n          wx.canvasToTempFilePath(opt, this);\n        });\n      }\n    },\n\n    touchStart(e) {\n      if (this.chart && e.touches.length > 0) {\n        var touch = e.touches[0];\n        var handler = this.chart.getZr().handler;\n        handler.dispatch('mousedown', {\n          zrX: touch.x,\n          zrY: touch.y\n        });\n        handler.dispatch('mousemove', {\n          zrX: touch.x,\n          zrY: touch.y\n        });\n        handler.processGesture(wrapTouch(e), 'start');\n      }\n    },\n\n    touchMove(e) {\n      if (this.chart && e.touches.length > 0) {\n        var touch = e.touches[0];\n        var handler = this.chart.getZr().handler;\n        handler.dispatch('mousemove', {\n          zrX: touch.x,\n          zrY: touch.y\n        });\n        handler.processGesture(wrapTouch(e), 'change');\n      }\n    },\n\n    touchEnd(e) {\n      if (this.chart) {\n        const touch = e.changedTouches ? e.changedTouches[0] : {};\n        var handler = this.chart.getZr().handler;\n        handler.dispatch('mouseup', {\n          zrX: touch.x,\n          zrY: touch.y\n        });\n        handler.dispatch('click', {\n          zrX: touch.x,\n          zrY: touch.y\n        });\n        handler.processGesture(wrapTouch(e), 'end');\n      }\n    }\n  }\n});\n\nfunction wrapTouch(event) {\n  for (let i = 0; i < event.touches.length; ++i) {\n    const touch = event.touches[i];\n    touch.offsetX = touch.x;\n    touch.offsetY = touch.y;\n  }\n  return event;\n}\n","export default class WxCanvas {\n  constructor(ctx, canvasId, isNew, canvasNode) {\n    this.ctx = ctx;\n    this.canvasId = canvasId;\n    this.chart = null;\n    this.isNew = isNew\n    if (isNew) {\n      this.canvasNode = canvasNode;\n    }\n    else {\n      this._initStyle(ctx);\n    }\n\n    // this._initCanvas(zrender, ctx);\n\n    this._initEvent();\n  }\n\n  getContext(contextType) {\n    if (contextType === '2d') {\n      return this.ctx;\n    }\n  }\n\n  // canvasToTempFilePath(opt) {\n  //   if (!opt.canvasId) {\n  //     opt.canvasId = this.canvasId;\n  //   }\n  //   return wx.canvasToTempFilePath(opt, this);\n  // }\n\n  setChart(chart) {\n    this.chart = chart;\n  }\n\n  attachEvent() {\n    // noop\n  }\n\n  detachEvent() {\n    // noop\n  }\n\n  _initCanvas(zrender, ctx) {\n    zrender.util.getContext = function () {\n      return ctx;\n    };\n\n    zrender.util.$override('measureText', function (text, font) {\n      ctx.font = font || '12px sans-serif';\n      return ctx.measureText(text);\n    });\n  }\n\n  _initStyle(ctx) {\n    var styles = ['fillStyle', 'strokeStyle', 'globalAlpha',\n      'textAlign', 'textBaseAlign', 'shadow', 'lineWidth',\n      'lineCap', 'lineJoin', 'lineDash', 'miterLimit', 'fontSize'];\n\n    styles.forEach(style => {\n      Object.defineProperty(ctx, style, {\n        set: value => {\n          if (style !== 'fillStyle' && style !== 'strokeStyle'\n            || value !== 'none' && value !== null\n          ) {\n            ctx['set' + style.charAt(0).toUpperCase() + style.slice(1)](value);\n          }\n        }\n      });\n    });\n\n    ctx.createRadialGradient = () => {\n      return ctx.createCircularGradient(arguments);\n    };\n  }\n\n  _initEvent() {\n    this.event = {};\n    const eventNames = [{\n      wxName: 'touchStart',\n      ecName: 'mousedown'\n    }, {\n      wxName: 'touchMove',\n      ecName: 'mousemove'\n    }, {\n      wxName: 'touchEnd',\n      ecName: 'mouseup'\n    }, {\n      wxName: 'touchEnd',\n      ecName: 'click'\n    }];\n\n    eventNames.forEach(name => {\n      this.event[name.wxName] = e => {\n        const touch = e.touches[0];\n        this.chart.getZr().handler.dispatch(name.ecName, {\n          zrX: name.wxName === 'tap' ? touch.clientX : touch.x,\n          zrY: name.wxName === 'tap' ? touch.clientY : touch.y\n        });\n      };\n    });\n  }\n\n  set width(w) {\n    if (this.canvasNode) this.canvasNode.width = w\n  }\n  set height(h) {\n    if (this.canvasNode) this.canvasNode.height = h\n  }\n\n  get width() {\n    if (this.canvasNode)\n      return this.canvasNode.width\n    return 0\n  }\n  get height() {\n    if (this.canvasNode)\n      return this.canvasNode.height\n    return 0\n  }\n}\n","function _typeof(o) {\n  \"@babel/helpers - typeof\";\n\n  return module.exports = _typeof = \"function\" == typeof Symbol && \"symbol\" == typeof Symbol.iterator ? function (o) {\n    return typeof o;\n  } : function (o) {\n    return o && \"function\" == typeof Symbol && o.constructor === Symbol && o !== Symbol.prototype ? \"symbol\" : typeof o;\n  }, module.exports.__esModule = true, module.exports[\"default\"] = module.exports, _typeof(o);\n}\nmodule.exports = _typeof, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;"],"names":[],"sourceRoot":""}